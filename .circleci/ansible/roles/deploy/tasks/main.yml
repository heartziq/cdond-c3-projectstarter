---
- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: backend
    state: directory
    mode: '0777'

- name: Copy backend dist files to remote server
  become: true
  copy:
    src: /root/project/artifact.tar.gz
    dest: /home/ubuntu

- name: Executing node
  become: true
  shell: |
    cd /home/ubuntu
    tar -vxf artifact.tar.gz -C backend
    rm -f artifact.tar.gz
    cd backend
    sudo npm i
    sudo npm run build
    pm2 stop default
    pm2 start npm -- start
    cd dist
    pm2 start main.js --update-env
